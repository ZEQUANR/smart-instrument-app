{"version":3,"file":"useChildren.js","sources":["uni_modules/wot-design-uni/components/composables/useChildren.ts"],"sourcesContent":["import {\n  provide,\n  reactive,\n  getCurrentInstance,\n  type VNode,\n  type InjectionKey,\n  type VNodeNormalizedChildren,\n  type ComponentPublicInstance,\n  type ComponentInternalInstance\n} from 'vue'\n\n// 小程序端不支持从vue导出的isVNode方法，参考uni-mp-vue的实现\nfunction isVNode(value: any): value is VNode {\n  return value ? value.__v_isVNode === true : false\n}\n\nexport function flattenVNodes(children: VNodeNormalizedChildren) {\n  const result: VNode[] = []\n\n  const traverse = (children: VNodeNormalizedChildren) => {\n    if (Array.isArray(children)) {\n      children.forEach((child) => {\n        if (isVNode(child)) {\n          result.push(child)\n\n          if (child.component?.subTree) {\n            result.push(child.component.subTree)\n            traverse(child.component.subTree.children)\n          }\n\n          if (child.children) {\n            traverse(child.children)\n          }\n        }\n      })\n    }\n  }\n\n  traverse(children)\n\n  return result\n}\n\nconst findVNodeIndex = (vnodes: VNode[], vnode: VNode) => {\n  const index = vnodes.indexOf(vnode)\n  if (index === -1) {\n    return vnodes.findIndex((item) => vnode.key !== undefined && vnode.key !== null && item.type === vnode.type && item.key === vnode.key)\n  }\n  return index\n}\n\n// sort children instances by vnodes order\nexport function sortChildren(\n  parent: ComponentInternalInstance,\n  publicChildren: ComponentPublicInstance[],\n  internalChildren: ComponentInternalInstance[]\n) {\n  const vnodes = parent && parent.subTree && parent.subTree.children ? flattenVNodes(parent.subTree.children) : []\n\n  internalChildren.sort((a, b) => findVNodeIndex(vnodes, a.vnode) - findVNodeIndex(vnodes, b.vnode))\n\n  const orderedPublicChildren = internalChildren.map((item) => item.proxy!)\n\n  publicChildren.sort((a, b) => {\n    const indexA = orderedPublicChildren.indexOf(a)\n    const indexB = orderedPublicChildren.indexOf(b)\n    return indexA - indexB\n  })\n}\n\nexport function useChildren<\n  // eslint-disable-next-line\n  Child extends ComponentPublicInstance = ComponentPublicInstance<{}, any>,\n  ProvideValue = never\n>(key: InjectionKey<ProvideValue>) {\n  const publicChildren: Child[] = reactive([])\n  const internalChildren: ComponentInternalInstance[] = reactive([])\n  const parent = getCurrentInstance()!\n\n  const linkChildren = (value?: ProvideValue) => {\n    const link = (child: ComponentInternalInstance) => {\n      if (child.proxy) {\n        internalChildren.push(child)\n        publicChildren.push(child.proxy as Child)\n        sortChildren(parent, publicChildren, internalChildren)\n      }\n    }\n\n    const unlink = (child: ComponentInternalInstance) => {\n      const index = internalChildren.indexOf(child)\n      publicChildren.splice(index, 1)\n      internalChildren.splice(index, 1)\n    }\n\n    provide(\n      key,\n      Object.assign(\n        {\n          link,\n          unlink,\n          children: publicChildren,\n          internalChildren\n        },\n        value\n      )\n    )\n  }\n\n  return {\n    children: publicChildren,\n    linkChildren\n  }\n}\n"],"names":["children","reactive","getCurrentInstance","provide"],"mappings":";;AAYA,SAAS,QAAQ,OAA4B;AACpC,SAAA,QAAQ,MAAM,gBAAgB,OAAO;AAC9C;AAEO,SAAS,cAAc,UAAmC;AAC/D,QAAM,SAAkB,CAAA;AAElB,QAAA,WAAW,CAACA,cAAsC;AAClD,QAAA,MAAM,QAAQA,SAAQ,GAAG;AAC3BA,gBAAS,QAAQ,CAAC,UAAU;;AACtB,YAAA,QAAQ,KAAK,GAAG;AAClB,iBAAO,KAAK,KAAK;AAEb,eAAA,WAAM,cAAN,mBAAiB,SAAS;AACrB,mBAAA,KAAK,MAAM,UAAU,OAAO;AAC1B,qBAAA,MAAM,UAAU,QAAQ,QAAQ;AAAA,UAC3C;AAEA,cAAI,MAAM,UAAU;AAClB,qBAAS,MAAM,QAAQ;AAAA,UACzB;AAAA,QACF;AAAA,MAAA,CACD;AAAA,IACH;AAAA,EAAA;AAGF,WAAS,QAAQ;AAEV,SAAA;AACT;AAEA,MAAM,iBAAiB,CAAC,QAAiB,UAAiB;AAClD,QAAA,QAAQ,OAAO,QAAQ,KAAK;AAClC,MAAI,UAAU,IAAI;AAChB,WAAO,OAAO,UAAU,CAAC,SAAS,MAAM,QAAQ,UAAa,MAAM,QAAQ,QAAQ,KAAK,SAAS,MAAM,QAAQ,KAAK,QAAQ,MAAM,GAAG;AAAA,EACvI;AACO,SAAA;AACT;AAGgB,SAAA,aACd,QACA,gBACA,kBACA;AACA,QAAM,SAAS,UAAU,OAAO,WAAW,OAAO,QAAQ,WAAW,cAAc,OAAO,QAAQ,QAAQ,IAAI,CAAA;AAE9G,mBAAiB,KAAK,CAAC,GAAG,MAAM,eAAe,QAAQ,EAAE,KAAK,IAAI,eAAe,QAAQ,EAAE,KAAK,CAAC;AAEjG,QAAM,wBAAwB,iBAAiB,IAAI,CAAC,SAAS,KAAK,KAAM;AAEzD,iBAAA,KAAK,CAAC,GAAG,MAAM;AACtB,UAAA,SAAS,sBAAsB,QAAQ,CAAC;AACxC,UAAA,SAAS,sBAAsB,QAAQ,CAAC;AAC9C,WAAO,SAAS;AAAA,EAAA,CACjB;AACH;AAEO,SAAS,YAId,KAAiC;AAC3B,QAAA,iBAA0BC,uBAAS,CAAA,CAAE;AACrC,QAAA,mBAAgDA,uBAAS,CAAA,CAAE;AACjE,QAAM,SAASC,cAAAA;AAET,QAAA,eAAe,CAAC,UAAyB;AACvC,UAAA,OAAO,CAAC,UAAqC;AACjD,UAAI,MAAM,OAAO;AACf,yBAAiB,KAAK,KAAK;AACZ,uBAAA,KAAK,MAAM,KAAc;AAC3B,qBAAA,QAAQ,gBAAgB,gBAAgB;AAAA,MACvD;AAAA,IAAA;AAGI,UAAA,SAAS,CAAC,UAAqC;AAC7C,YAAA,QAAQ,iBAAiB,QAAQ,KAAK;AAC7B,qBAAA,OAAO,OAAO,CAAC;AACb,uBAAA,OAAO,OAAO,CAAC;AAAA,IAAA;AAGlCC,kBAAA;AAAA,MACE;AAAA,MACA,OAAO;AAAA,QACL;AAAA,UACE;AAAA,UACA;AAAA,UACA,UAAU;AAAA,UACV;AAAA,QACF;AAAA,QACA;AAAA,MACF;AAAA,IAAA;AAAA,EACF;AAGK,SAAA;AAAA,IACL,UAAU;AAAA,IACV;AAAA,EAAA;AAEJ;;"}